#!/bin/bash

# ================================================================================
# PostgreSQL Standard Dashboard
# Desenvolvido para Trabalho de Gradua√ß√£o
# 
# Dashboard interativo para ambiente PostgreSQL padr√£o (baseline)
# Permite compara√ß√£o com ambiente Citus distribu√≠do
# ================================================================================

set -euo pipefail

# ================================================================================
# CONFIGURA√á√ïES E CONSTANTES
# ================================================================================

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Configura√ß√µes do banco
DATABASE_NAME="benchmark_db"
POSTGRES_USER="postgres"
POSTGRES_PASSWORD="postgres"

# ================================================================================
# FUN√á√ïES DE UTILIDADE
# ================================================================================

# Fun√ß√£o para logging com timestamp
log() {
    local level=$1
    shift
    local message="$*"
    local timestamp=$(date '+%H:%M:%S')
    
    case $level in
        "INFO")  echo -e "${GREEN}[${timestamp}]${NC} $message" ;;
        "WARN")  echo -e "${YELLOW}[${timestamp}]${NC} $message" ;;
        "ERROR") echo -e "${RED}[${timestamp}]${NC} $message" ;;
        "DEBUG") echo -e "${CYAN}[${timestamp}]${NC} $message" ;;
        *)       echo -e "[${timestamp}] $message" ;;
    esac
}

# Fun√ß√£o para verificar se container est√° rodando
is_container_running() {
    local container_name=$1
    docker ps --format "{{.Names}}" | grep -q "^${container_name}$"
}

# Fun√ß√£o para aguardar PostgreSQL estar pronto
wait_for_postgres() {
    log "INFO" "Aguardando PostgreSQL estar pronto..."
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if docker exec pg_standard pg_isready -U postgres >/dev/null 2>&1; then
            log "INFO" "‚úÖ PostgreSQL pronto!"
            return 0
        fi
        
        echo -n "."
        sleep 2
        ((attempt++))
    done
    
    log "ERROR" "‚ùå PostgreSQL n√£o ficou pronto ap√≥s ${max_attempts} tentativas"
    return 1
}

# ================================================================================
# FUN√á√ïES DE STATUS
# ================================================================================

# Mostrar status dos containers
show_containers_status() {
    echo -e "\n${BLUE}üì¶ STATUS DOS CONTAINERS${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    local containers=("pg_standard" "postgres_exporter" "node_exporter" "prometheus_pg" "grafana_pg" "pgbench")
    
    for container in "${containers[@]}"; do
        if is_container_running "$container"; then
            local status="üü¢ ATIVO"
            local uptime=$(docker ps --format "{{.Status}}" --filter "name=^${container}$")
            echo -e "   ${container}: ${GREEN}${status}${NC} (${uptime})"
        else
            echo -e "   ${container}: ${RED}üî¥ INATIVO${NC}"
        fi
    done
}

# Mostrar status do banco de dados
show_database_status() {
    echo -e "\n${BLUE}üóÑÔ∏è  STATUS DO BANCO DE DADOS${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    if ! is_container_running "pg_standard"; then
        echo -e "   ${RED}‚ùå PostgreSQL n√£o est√° rodando${NC}"
        return
    fi
    
    # Verificar se o database existe
    local db_exists=$(docker exec pg_standard psql -U postgres -t -c "SELECT 1 FROM pg_database WHERE datname='${DATABASE_NAME}'" 2>/dev/null | grep -c "1" || echo "0")
    
    if [ "$db_exists" = "1" ]; then
        echo -e "   Database: ${GREEN}‚úÖ ${DATABASE_NAME}${NC}"
        
        # Verificar tabelas
        local tables_count=$(docker exec pg_standard psql -U postgres -d "${DATABASE_NAME}" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public'" 2>/dev/null || echo "0")
        echo -e "   Tabelas: ${GREEN}${tables_count} tabelas criadas${NC}"
        
        # Verificar dados
        if [ "$tables_count" -gt "0" ]; then
            local total_records=0
            local tables=("companies" "campaigns" "ads" "system_metrics")
            
            for table in "${tables[@]}"; do
                local count=$(docker exec pg_standard psql -U postgres -d "${DATABASE_NAME}" -t -c "SELECT COUNT(*) FROM ${table}" 2>/dev/null || echo "0")
                if [ "$count" -gt "0" ]; then
                    echo -e "   ‚Ä¢ ${table}: ${GREEN}${count} registros${NC}"
                    ((total_records += count))
                else
                    echo -e "   ‚Ä¢ ${table}: ${YELLOW}vazia${NC}"
                fi
            done
            
            echo -e "   Total de registros: ${GREEN}${total_records}${NC}"
        fi
    else
        echo -e "   Database: ${YELLOW}‚ö†Ô∏è  ${DATABASE_NAME} n√£o criado${NC}"
    fi
}

# Mostrar status dos servi√ßos de monitoramento
show_monitoring_status() {
    echo -e "\n${BLUE}üìä SERVI√áOS DE MONITORAMENTO${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    # Prometheus
    if is_container_running "prometheus_pg"; then
        echo -e "   Prometheus: ${GREEN}‚úÖ Ativo${NC} - http://localhost:9090"
    else
        echo -e "   Prometheus: ${RED}‚ùå Inativo${NC}"
    fi
    
    # Grafana
    if is_container_running "grafana_pg"; then
        echo -e "   Grafana: ${GREEN}‚úÖ Ativo${NC} - http://localhost:3000 (admin/admin)"
    else
        echo -e "   Grafana: ${RED}‚ùå Inativo${NC}"
    fi
    
    # Postgres Exporter
    if is_container_running "postgres_exporter"; then
        echo -e "   Postgres Exporter: ${GREEN}‚úÖ Ativo${NC} - http://localhost:9187"
    else
        echo -e "   Postgres Exporter: ${RED}‚ùå Inativo${NC}"
    fi
    
    # Node Exporter
    if is_container_running "node_exporter"; then
        echo -e "   Node Exporter: ${GREEN}‚úÖ Ativo${NC} - http://localhost:9100"
    else
        echo -e "   Node Exporter: ${RED}‚ùå Inativo${NC}"
    fi
}

# ================================================================================
# FUN√á√ïES DE OPERA√á√ÉO
# ================================================================================

# Iniciar ambiente
start_environment() {
    echo -e "\n${PURPLE}üöÄ INICIANDO AMBIENTE POSTGRESQL${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    log "INFO" "Iniciando containers com docker-compose..."
    
    if docker-compose up -d; then
        log "INFO" "‚úÖ Containers iniciados com sucesso!"
        
        # Aguardar PostgreSQL
        if wait_for_postgres; then
            echo -e "\n${GREEN}‚úÖ Ambiente PostgreSQL iniciado com sucesso!${NC}"
            echo -e "\nüìù Para conectar ao banco:"
            echo -e "   docker exec -it pg_standard psql -U postgres -d ${DATABASE_NAME}"
        fi
    else
        log "ERROR" "‚ùå Falha ao iniciar containers"
        return 1
    fi
}

# Parar ambiente
stop_environment() {
    echo -e "\n${PURPLE}‚èπÔ∏è  PARANDO AMBIENTE${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    log "INFO" "Parando todos os containers..."
    
    if docker-compose down; then
        log "INFO" "‚úÖ Ambiente parado com sucesso!"
    else
        log "ERROR" "‚ùå Falha ao parar containers"
        return 1
    fi
}

# Limpar ambiente completamente
cleanup_environment() {
    echo -e "\n${PURPLE}üßπ LIMPEZA COMPLETA DO AMBIENTE${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    read -p "‚ö†Ô∏è  Isso ir√° remover TODOS os dados. Confirma? (y/N): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log "INFO" "Parando e removendo containers e volumes..."
        
        docker-compose down -v 2>/dev/null || true
        
        log "INFO" "‚úÖ Limpeza conclu√≠da!"
    else
        log "INFO" "Opera√ß√£o cancelada"
    fi
}

# Criar schema do banco
setup_database() {
    echo -e "\n${PURPLE}üèóÔ∏è  CONFIGURANDO BANCO DE DADOS${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    if ! is_container_running "pg_standard"; then
        log "ERROR" "‚ùå PostgreSQL n√£o est√° rodando. Execute 'start' primeiro."
        return 1
    fi
    
    log "INFO" "Criando database ${DATABASE_NAME}..."
    
    # Criar database se n√£o existir
    docker exec pg_standard psql -U postgres -c "CREATE DATABASE ${DATABASE_NAME}" 2>/dev/null || log "INFO" "Database j√° existe"
    
    log "INFO" "Executando script de schema..."
    
        # Execute schema script
    if [ -f "schema.sql" ]; then
        docker exec -i pg_standard psql -U postgres -d "${DATABASE_NAME}" < schema.sql
        log "INFO" "‚úÖ Schema created successfully!"
    else
        log "ERROR" "‚ùå Arquivo schema.sql n√£o encontrado"
        return 1
    fi
}

# Carregar dados
load_data() {
    echo -e "\n${PURPLE}üì• CARREGANDO DADOS${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    if ! is_container_running "pg_standard"; then
        log "ERROR" "‚ùå PostgreSQL n√£o est√° rodando. Execute 'start' primeiro."
        return 1
    fi
    
    # Verificar se database e tabelas existem
    local db_exists=$(docker exec pg_standard psql -U postgres -t -c "SELECT 1 FROM pg_database WHERE datname='${DATABASE_NAME}'" 2>/dev/null | grep -c "1" || echo "0")
    
    if [ "$db_exists" = "0" ]; then
        log "ERROR" "‚ùå Database ${DATABASE_NAME} n√£o existe. Execute 'setup' primeiro."
        return 1
    fi
    
    if [ -f "load_data.sh" ]; then
        log "INFO" "Executando carregamento de dados..."
        bash load_data.sh "${DATABASE_NAME}"
        log "INFO" "‚úÖ Dados carregados com sucesso!"
    else
        log "ERROR" "‚ùå Script load_data.sh n√£o encontrado"
        return 1
    fi
}

# Executar benchmark
run_benchmark() {
    echo -e "\n${PURPLE}‚ö° EXECUTANDO BENCHMARK${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    if ! is_container_running "pg_standard"; then
        log "ERROR" "‚ùå PostgreSQL n√£o est√° rodando. Execute 'start' primeiro."
        return 1
    fi
    
    if [ -f "pgbench_professional.sh" ]; then
        log "INFO" "Iniciando benchmark profissional..."
        bash pgbench_professional.sh
        log "INFO" "‚úÖ Benchmark conclu√≠do! Verifique os resultados em benchmark/"
    else
        log "ERROR" "‚ùå Script pgbench_professional.sh n√£o encontrado"
        return 1
    fi
}

# ================================================================================
# MENU PRINCIPAL
# ================================================================================

show_main_menu() {
    clear
    echo -e "${WHITE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë              üêò POSTGRESQL STANDARD DASHBOARD               ‚ïë"
    echo "‚ïë                    Ambiente de Baseline                     ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    
    show_containers_status
    show_database_status
    show_monitoring_status
    
    echo -e "\n${YELLOW}üéØ OPERA√á√ïES DISPON√çVEIS:${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo -e "   ${GREEN}1.${NC} start      ‚Üí Iniciar ambiente completo"
    echo -e "   ${GREEN}2.${NC} setup      ‚Üí Criar database e tabelas"
    echo -e "   ${GREEN}3.${NC} load-data  ‚Üí Carregar dados CSV"
    echo -e "   ${GREEN}4.${NC} benchmark  ‚Üí Executar benchmark"
    echo -e "   ${GREEN}5.${NC} stop       ‚Üí Parar ambiente"
    echo -e "   ${GREEN}6.${NC} cleanup    ‚Üí Limpeza completa"
    echo -e "   ${GREEN}7.${NC} logs       ‚Üí Ver logs dos containers"
    echo -e "   ${GREEN}8.${NC} connect    ‚Üí Conectar ao PostgreSQL"
    echo -e "   ${GREEN}r.${NC} refresh    ‚Üí Atualizar status"
    echo -e "   ${GREEN}q.${NC} quit       ‚Üí Sair"
    
    echo -e "\n${BLUE}üìñ FLUXO RECOMENDADO:${NC}"
    echo -e "   1. start ‚Üí 2. setup ‚Üí 3. load-data ‚Üí 4. benchmark"
    
    echo -e "\n${CYAN}üîó ACESSO R√ÅPIDO:${NC}"
    echo -e "   ‚Ä¢ PostgreSQL: docker exec -it pg_standard psql -U postgres -d ${DATABASE_NAME}"
    echo -e "   ‚Ä¢ Grafana: http://localhost:3000 (admin/admin)"
    echo -e "   ‚Ä¢ Prometheus: http://localhost:9090"
    
    echo -e "\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
}

# Ver logs dos containers
show_logs() {
    echo -e "\n${PURPLE}üìã LOGS DOS CONTAINERS${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    echo -e "Escolha o container:"
    echo -e "   ${GREEN}1.${NC} pg_standard (PostgreSQL)"
    echo -e "   ${GREEN}2.${NC} prometheus_pg"
    echo -e "   ${GREEN}3.${NC} grafana_pg"
    echo -e "   ${GREEN}4.${NC} postgres_exporter"
    
    read -p "Op√ß√£o (1-4): " -n 1 -r
    echo
    
    case $REPLY in
        1) docker logs --tail 50 pg_standard ;;
        2) docker logs --tail 50 prometheus_pg ;;
        3) docker logs --tail 50 grafana_pg ;;
        4) docker logs --tail 50 postgres_exporter ;;
        *) log "ERROR" "Op√ß√£o inv√°lida" ;;
    esac
    
    read -p "Pressione Enter para continuar..."
}

# Conectar ao PostgreSQL
connect_to_postgres() {
    echo -e "\n${PURPLE}üîå CONECTANDO AO POSTGRESQL${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    if ! is_container_running "pg_standard"; then
        log "ERROR" "‚ùå PostgreSQL n√£o est√° rodando"
        read -p "Pressione Enter para continuar..."
        return 1
    fi
    
    log "INFO" "Conectando ao database ${DATABASE_NAME}..."
    docker exec -it pg_standard psql -U postgres -d "${DATABASE_NAME}"
}

# ================================================================================
# LOOP PRINCIPAL
# ================================================================================

main() {
    # Verificar se estamos no diret√≥rio correto
    if [[ ! -f "docker-compose.yml" ]]; then
        log "ERROR" "Arquivo docker-compose.yml n√£o encontrado!"
        log "ERROR" "Execute este script no diret√≥rio /postgre"
        exit 1
    fi
    
    # Loop principal do menu interativo
    while true; do
        show_main_menu
        
        echo -ne "\n${YELLOW}Digite sua op√ß√£o: ${NC}"
        read -r choice
        
        case $choice in
            "1"|"start")
                start_environment
                read -p "Pressione Enter para continuar..."
                ;;
            "2"|"setup")
                setup_database
                read -p "Pressione Enter para continuar..."
                ;;
            "3"|"load-data")
                load_data
                read -p "Pressione Enter para continuar..."
                ;;
            "4"|"benchmark")
                run_benchmark
                read -p "Pressione Enter para continuar..."
                ;;
            "5"|"stop")
                stop_environment
                read -p "Pressione Enter para continuar..."
                ;;
            "6"|"cleanup")
                cleanup_environment
                read -p "Pressione Enter para continuar..."
                ;;
            "7"|"logs")
                show_logs
                ;;
            "8"|"connect")
                connect_to_postgres
                ;;
            "r"|"refresh")
                # Apenas atualiza o menu
                ;;
            "q"|"quit")
                echo -e "\n${GREEN}üëã At√© logo!${NC}"
                exit 0
                ;;
            "")
                # Enter vazio apenas atualiza
                ;;
            *)
                log "ERROR" "Op√ß√£o inv√°lida: $choice"
                read -p "Pressione Enter para continuar..."
                ;;
        esac
    done
}

# Verificar se foi chamado com par√¢metro (modo n√£o-interativo)
if [ $# -gt 0 ]; then
    case "$1" in
        "start") start_environment ;;
        "setup") setup_database ;;
        "load-data") load_data ;;
        "benchmark") run_benchmark ;;
        "stop") stop_environment ;;
        "cleanup") cleanup_environment ;;
        "status") 
            show_containers_status
            show_database_status
            show_monitoring_status
            ;;
        *)
            echo "Uso: $0 [start|setup|load-data|benchmark|stop|cleanup|status]"
            echo "Ou execute sem par√¢metros para modo interativo"
            exit 1
            ;;
    esac
else
    # Modo interativo
    main
fi