global
    daemon
    log stdout local0 info
    maxconn 4096

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    retries 3
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Health check para PostgreSQL
listen postgresql-check
    bind *:8080
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s

# Load balancer para Worker Group 1
frontend worker1_frontend
    bind *:5432
    default_backend worker1_backend

backend worker1_backend
    balance first
    option tcp-check
    tcp-check connect
    tcp-check send-binary 00000020  # PostgreSQL startup message length
    tcp-check send-binary 00030000  # Protocol version 3.0
    tcp-check send-binary 7573657200  # "user\0"
    tcp-check send-binary 706f737467726573  # "postgres"
    tcp-check send-binary 0064617461626173650000  # "\0database\0\0"
    tcp-check expect binary 52  # Ready for query message type 'R'
    
    # Primary server (preferido)
    server worker1-primary worker1:5432 check inter 3000ms rise 2 fall 3 weight 100
    # Standby server (backup)
    server worker1-standby worker1-standby:5432 check inter 3000ms rise 2 fall 3 weight 1 backup
